# Ex-Otogi Engineering Governance (Trae + Human)

## Scope
This repository is a high-concurrency, event-driven Golang system. These rules are mandatory for all code generated by Trae and all human contributions.

## Architecture (Non-Negotiable)
Dependency flow is strict:
1. `pkg/otogi` (interfaces/contracts)
2. `internal/kernel` (core logic, orchestration)
3. `internal/driver` (Telegram/platform/plugin implementations)

Rules:
- `pkg/otogi` must not import from `internal/*`.
- `internal/kernel` must not import from `internal/driver`.
- `internal/driver` may import `internal/kernel` and `pkg/otogi`.
- Keep business logic in `internal/kernel`; drivers only adapt I/O and external SDKs.

## Concurrency Safety
- `context.Context` is required for all request-scoped, blocking, or long-lived operations.
- Accept `ctx context.Context` as the first parameter for cancellable operations.
- Never start a goroutine without a clear stop mechanism:
  - context cancellation,
  - closed channel,
  - bounded worker lifecycle,
  - or `errgroup.WithContext`.
- Every goroutine entrypoint must guard against panics and report failure.
- Prefer channels for ownership transfer and pipeline fan-out/fan-in.
- Prefer `sync.Mutex`/`sync.RWMutex` for protecting shared mutable state.
- Close channels only from the producer/owner; never close from receivers.

## Error Handling
- No silent failures. Handle every returned error.
- Wrap errors with operation context using `%w`:
  - `fmt.Errorf("publish event %s: %w", topic, err)`
- Never use `panic` for expected control flow.
- Logging an error is not handling an error unless propagation/retry/fallback is explicit.

## Reliability and Recovery
- Recover panics at goroutine/task boundaries and plugin boundaries.
- Propagate cancellation and deadlines across kernel -> drivers.
- External calls (Telegram/network/disk) must be bounded by context deadlines or timeouts.

## Testing Standards
- Core logic tests must be table-driven.
- Interface collaborators must be mocked (generate mocks from interfaces).
- `go test -race ./...` is mandatory before merge.
- Add leak protection in long-lived/concurrency-heavy tests (for example with `goleak`).
- Tests for async/event bus code must assert cancellation/termination behavior.

## Code Style and Maintainability
- Keep functions small and composable.
- Avoid hidden global state.
- Prefer explicit constructors and dependency injection.
- Every exported symbol must have Godoc:
  - exported package-level functions/types/vars/consts,
  - exported methods,
  - exported interface methods,
  - exported struct fields.
- Godoc must describe behavior and semantics, not restate obvious names.
- Public APIs in `pkg/otogi` require doc comments and stable semantics.

## Agent Ownership and Architectural Discretion
- The agent must execute each task with project-owner responsibility, not just local patching.
- Always evaluate impact on the full system architecture (`pkg/otogi` -> `internal/kernel` -> `internal/driver`) before changing code.
- Prefer solutions that improve long-term maintainability, testability, and boundary clarity over short-term convenience.
- When multiple implementations are possible, choose the option that is most architecture-safe and future-proof.

## Trae Execution Checklist
Before proposing or committing code, Trae must verify:
1. Architecture dependency flow is preserved.
2. Context propagation and goroutine shutdown paths are explicit.
3. Errors are wrapped with `%w` and never dropped.
4. Tests include table-driven coverage and race-safe behavior.
5. Exported symbols follow required Godoc standards.
6. After each task, quality checks are run via Makefile commands:
   - `make lint`
   - `make arch-check`
   - `make test`
